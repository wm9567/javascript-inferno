<html>
<head>
</head>
<body>
<div id="app"></div>

<script>

  var forEach = function(values, key, children) {
    var result = [];
    for(var i = 0; i < values.length; i++) {
      result.push({
        children: children,
        prop: values[i]
      });
    }
    return result;
  };

  var Engine = {
    each: function(values, key, children) {
      return forEach.bind(this, values, key, children);
    }
  }

  Engine.Part = function(funcs) {
    this._map = {};
    this._domTree = {};
    this._funcs = funcs;
  }

  Engine.Part.prototype.mount = function(root) {
    this._map = this._funcs.template.call(this);
    this._createDomTree(root, this._map, {}, 0);
  };

  Engine.Part.prototype._createDomTree = function(parent, map, props, depth) {
    var elem = null,
        children = [],
        elemName = '',
        mappings = [],
        i = 0;
    depth++;

    if(props[depth] == null) {
      props[depth] = [];
    }

    for(elemName in map) {
      //if it has an underscore, it's a property of the parent
      if(elemName.indexOf("_") > -1) {
        parent.setAttribute(elemName.substring(1), map[elemName]);
      }
      //controller, such as for, if, else etc
      else if(elemName.indexOf("$") > -1) {
          switch(elemName) {
            case "$for":
              //this is a for, so let's exectue the foreach and get back the results
              mappings = map[elemName]();
              for(i = 0; i < mappings.length; i++) {
                props[depth].push(mappings[i].prop);
                this._createDomTree(parent, mappings[i].children, props, depth);
              }
              break;
          }
      }
      else {
        elem = document.createElement(elemName);
        parent.appendChild(elem);
        if(typeof(map[elemName]) === "string") {
          elem.textContent = this._applyBinding(map[elemName], props);
        } else {
          this._createDomTree(elem, map[elemName], props, depth);
        }
      }
    }
  };

  Engine.Part.prototype._applyBinding = function(string, props) {

  };


  var todos = ['Take out the trash', 'Finish paperwork', 'Do some work', 'Play some music', 'Clean the dishes'];

  var demoComponent = new Engine.Part({
    init: function() {

    },
    template: function() {
      return {
        div: { _id: "test-id", _class: "test-demo",
          ul: { _id: "todos",
            $for: {each: 'todos', as: 'todo', {
              li: { _class: "todo-item",
                div: {
                  h2: "Todo title",
                  span: "Content: { todo }"
                }
              }
            }
          }
        }
      };
    }
  });

  demoComponent.mount(document.getElementById('app'));

</script>
</body>
</html>
