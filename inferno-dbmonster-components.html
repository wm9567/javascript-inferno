<html>
<head>
  <title>Inferno example</title>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app"></div>

  <script src="inferno.js"></script>
  <script src="data.js"></script>
  <script src="lib/memory-stats.js"></script>
  <script src="lib/monitor.js"></script>
  <script src="t7.js"></script>
  <script>
    "use strict";

    var data = {Database: Database};
    var I = 0;
    var N = 100;

    (function() {
      class Query extends Inferno.Component {
        constructor(props) {
          super();
          this.elapsed = props.elapsed;
          this.query = props.query;
        }
        beforeRender(props) {
          this.elapsed = props.elapsed;
          this.query = props.query;
        }
        render() {
          return t7`
            <td class=${ 'Query ' + this._elapsedClassName(this.elapsed) }>
              <span class="foo">${ this._formatElapsed(this.elapsed) }</span>
              <div class="popover left">
                <div class="popover-content">${ this.query }</div>
                <div class="arrow"></div>
              </div>
            </td>
          `
        }
        _formatElapsed(value) {
          if (!value) return '';
          var str = parseFloat(value).toFixed(2);
          if (value > 60) {
              var minutes = Math.floor(value / 60);
              var comps = (value % 60).toFixed(2).split('.');
              var seconds = comps[0].lpad('0', 2);
              var ms = comps[1];
              str = minutes + ":" + seconds + "." + ms;
          }
          return str;
        };
        _elapsedClassName(elapsed) {
          var className = 'Query elapsed';
          if (elapsed >= 10.0) {
              className += ' warn_long';
          }
          else if (elapsed >= 1.0) {
              className += ' warn';
          }
          else {
              className += ' short';
          }
          return className;
        }
      }

      Inferno.register("Query", Query);
    })();

    (function() {
      class Database extends Inferno.Component {
        constructor(props) {
          super();
          this.name = props.name;
          this.queries = props.queries;
          this.topFiveQueries = props.topFiveQueries;
        }
        beforeRender(props) {
          this.name = props.name;
          this.queries = props.queries;
          this.topFiveQueries = props.topFiveQueries;
        }
        render() {
          return t7`
            <tr>
              <td class="dbname">${ this.name }</td>
              <td class="query-count"><span class=${ this._getCountClassName() }>${ this.queries.length }</span></td>
              ${ this.topFiveQueries.map(this._renderQuery) }
            </tr>
          `;
        }
        _renderQuery(query) {
          return t7`
            <Query elapsed=${ query.elapsed } query=${ query.query } />
          `;
        }
        _getTopFiveQueries() {
            var qs = this.queries.slice();
            qs.sort(function(a, b) {
                return a.elapsed - b.elapsed;
            });
            qs = qs.slice(0, 5);
            while (qs.length < 5) {
                qs.push(new Query(0.0, false, ''));
            }
            return qs;
        };

        _getCountClassName() {
          var count = this.queries.length;
          var className = 'label';
          if (count >= 20) {
              className += ' label-important';
          }
          else if (count >= 10) {
              className += ' label-warning';
          }
          else {
              className += ' label-success';
          }
          return className;
        }
      };

      Inferno.register("Database", Database);
    })();


    (function() {
      class App extends Inferno.Component {
        constructor() {
          super();
          this.dbs = [];
          this._updateDbs = this._updateDbs.bind(this)
          this._updateDbs();
        }
        _updateDbs() {
          this.dbs = [];
          for (var i = 0; i < N; i++) {
            this.dbs.push(new data.Database('cluster' + i));
            this.dbs.push(new data.Database('cluster' + i + 'slave'));
          }
          //this.forceUpdate();
          Monitoring.renderRate.ping();
          setTimeout(this._updateDbs, 0);
        }
        render() {
          return t7`
            <table class="table table-striped latest-data">
              <tbody>
                ${ this.dbs.map(this._renderDatabase) }
              </tbody>
            </table>
          `;
        }
        _renderDatabase(db) {
          return t7`
            <Database name=${ db.name } queries=${ db.queries } topFiveQueries=${ db.getTopFiveQueries() } />
          `;
        }
      };

      Inferno.register("App", App);
    })();

    var app = document.getElementById("app");

    function update() {
      Inferno.render(t7`
        <App />
      `, app)

      window.setTimeout(update);
    }

    update();

  </script>
</body>
</html>
