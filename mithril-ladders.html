<html>
<head>
  <title>Ladders Demo with Inferno</title>
  <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700'>
  <link rel='stylesheet prefetch' href='http://boomtownroi.github.io/boomstrap/css/boomstrap.css'>
  <style>
    * {
      box-sizing: border-box;
    }
    html,
    body {
      margin: 0;
      padding: 0;
    }
    body {
      background-color: #455A64;
      color: #212121;
      font-family: Verdana;
      font-size: 11px;
      padding-bottom: 100px;
    }
    .ladder-row {
      display: table-row;
    }
    .ladder-cell {
      display: table-cell;
      width: 120px;
      position: relative;
      height: 24px;
      padding: 0;
      line-height: 24px;
      vertical-align: top;
      text-align: center;
    }
    .ladder-cell-price {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .component {
      display: inline-block;
      margin: 14px 0 0 14px;
      background-color: #fff;
    }
    .ladder-row:nth-child(odd) {
      background-color: #F5F5F5;
    }
    .app-header {
      background-color: #5F7C8A;
      color: #fff;
      font-size: 20px;
      padding: 30px;
      margin: 0;
    }
    .component header {
      background-color: #CFD8DC;
      font-size: 14px;
      padding: 10px;
    }
    /* NumberBar */
    .numberbar {
      position: relative;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    .numberbar-bar {
      position: absolute;
      top: 0;
      left: 0;
      background-color: #b1cfa7;
      height: 100%;
      width: 100%;
      z-index: 1;
    }
    .transitions .numberbar-bar {
      transition: transform 0.13s ease-out;
    }
    .numberbar-bar-ask {
      left: auto;
      right: 0;
      background-color: #e9aebc;
    }
    .numberbar-number {
      position: relative;
      z-index: 5;
    }
  </style>
</head>
<body class="transitions">
  <div id="app"></app>
  <script src='https://rawgit.com/MikeMcl/big.js/master/big.js'></script>
  <script src="mithril.min.js"></script>
  <script>

    var THROTTLE = 200;
    var NUMBER_OF_LADDERS = 6;

    var PriceLevel = function(price, side, throttle) {
      this.price = price;
      this.side = side;
      this.key = PriceLevel.COUNT++;

      this.bidVolume = (side === "bid") ? Math.floor(Math.random() * 400) + 100 : "";
      this.askVolume = (side === "ask") ? Math.floor(Math.random() * 400) + 100 : "";

      this._generate();
      setInterval(this._generate.bind(this), throttle);
    };
    PriceLevel.COUNT = 0;

    PriceLevel.prototype._generate = function() {
      var volumeDifference = Math.floor(Math.random() * 200) - 100;

      if (this.side === "bid") {
        var volume = this.bidVolume + volumeDifference;
        if (volume < 100) {
          volume = 100;
        } else if (volume > 500) {
          volume = 500;
        }
        this.bidVolume = volume;
      } else {
        var volume = this.askVolume + volumeDifference;
        if (volume < 100) {
          volume = 100;
        } else if (volume > 500) {
          volume = 500;
        }
        this.askVolume = volume;
      }

    };

    var OrdersModel = function() {
      this.levels = [];

      var depth = 10;
      var market = Math.floor(depth / 2) - 1;
      this.priceStart = Big(Math.random() + 1);
      this.priceStep = 0.00001;
      var throttleMin = 50;
      var throttleStep = 200;
      var price = this.priceStart;

      for (var i = 0; i < depth; i++) {

        var marketDistance = Math.abs(market - i);
        var throttle = throttleMin + (throttleStep * marketDistance);
        var diff = Number((i * this.priceStep).toFixed(5));
        price = (Number(price) - diff).toFixed(5);
        var side = (i > market) ? "ask" : "bid";

        this.levels.push(new PriceLevel(price, side, throttle));
      };

      this.maxVolume = 500;

      window.setInterval(this._moveMarket.bind(this), Math.floor(Math.random() * 700) + 400);
    };

    OrdersModel.prototype._moveMarket = function() {
      var multiplier = (Math.random() > 0.5) ? 1 : -1;
      this.priceStart = Big(this.priceStart).plus(Big(this.priceStep).times(multiplier));

      var priceStep = new Big(this.priceStep);
      var price = Big(this.priceStart);

      for (var i = 0; i < this.levels.length; i++) {
        price = Big(price.minus(priceStep));
        this.levels[i].price = price.toFixed(5).toString();
      };
    };

    var NumberBar = {};

    NumberBar.controller = function() {
      this.selected = false;
      this.mouseOver = false;
      this.type = "";
      this.barClass = "";
      this.maxBarWidth = 0;
      this.number = 0;
      this.maxNumber = 0;
    }

    NumberBar.controller.prototype.getNumberBarStyle = function() {
      var background, color;

      if (this.selected) {
        background = "rgb(100,100,100)";
        color = "#ffffff";
      } else if (this.mouseOver) {
        background = "rgb(200,200,200)";
        color = "";
      } else {
        background = "";
        color = "";
      }

      return {
        backgroundColor: background,
        color: color
      };
    }

    NumberBar.controller.prototype.getBarStyle = function() {
      var ratio = this.number / this.maxNumber;
      var value = ratio * this.maxBarWidth + "px";
      var display = this.mouseOver || this.selected ? "none" : "";
      var translate = (1 - ratio) * 100;

      if (this.type === "ask") {
        translate = -translate;
      }

      return {
        display: display,
        transform: "translateX(" + translate + "%)"
      }
    }

    NumberBar.view = function(ctrl, data) {

      ctrl.number = data.number;
      ctrl.maxNumber = data.maxNumber;
      ctrl.maxBarWidth = data.maxBarWidth;
      ctrl.type = data.type;

      return m("div.ladder-cell", [
        m('div.numberbar', {style: ctrl.getNumberBarStyle()}, [
          m('div', {className: "numberbar-bar numberbar-bar-" + ctrl.type, style: ctrl.getBarStyle()}),
          m('div.numberbar-number', ctrl.number)
        ])
      ]);
    }

    var LadderRow = {};

    LadderRow.controller = function() {
      this.askBar = new NumberBar.controller();
      this.bidBar = new NumberBar.controller();
    }

    LadderRow.view = function(ctrl, priceLevel) {

      var bidData = {
          type: "bid",
          number: priceLevel.bidVolume,
          maxNumber: ordersModel.maxVolume,
          maxBarWidth: "120"
      }

      var askData = {
          type: "ask",
          number: priceLevel.askVolume,
          maxNumber: ordersModel.maxVolume,
          maxBarWidth: "120"
      }

      return m('div.ladder-row', [
        NumberBar.view(ctrl.askBar, bidData),
        m("div", {className: "ladder-cell ladder-cell-price"}, priceLevel.price),
        NumberBar.view(ctrl.askBar, askData)
      ]);
    }

    var Ladder = {};

    Ladder.controller = function() {

      this.ladderRows = ordersModel.levels.map(function(priceLevel, index) {
        return {
          ladderRow: new LadderRow.controller(),
          priceLevel: priceLevel
        }
      }.bind(this));

    };

    Ladder.view = function(ctrl) {
      return m("div.component", [
        m("div.ladder", [
          m('header', "Apple (AAPL)"),
        ]),
        m("div.bars", [
          ctrl.ladderRows.map(function(data, index) {
            return LadderRow.view(data.ladderRow, data.priceLevel);
          })
        ])
      ]);
    };

    var LaddersApp = {};

    //controller
    LaddersApp.controller = function() {
      this.ladders = [];

      setInterval(function() {
        m.redraw()
      }.bind(this), THROTTLE + (Math.floor(Math.random() * 120)) - 60);

      for(var i = 0; i < NUMBER_OF_LADDERS; i++) {
        this.ladders.push(new Ladder.controller());
      }
    };

    //view
    LaddersApp.view = function(ctrl) {
      return [
        m("div.components", [
          ctrl.ladders.map(function(ladder) {
            return Ladder.view(ladder)
          })
        ])
      ];
    };

    var ordersModel = new OrdersModel();
    //initialize
    m.module(document.getElementById("app"), LaddersApp);
  </script>
</body>
</html>
