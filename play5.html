<html>
<script>

  var Inferno = (function() {

    function isFunction(functionToCheck) {
      var getType = {};
      return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
    }

    function Component( data ) {
      this._lastChecks = [];
      this._propHasChanged = {};
      this._checkDeps = false;
      this._vDom = {};
      //apply the constructor to this component
      data.constructor.apply(this);
      //go through the new properties and bind them to this component
      this._attachBindings();
      //handle the template
      this._template = data.template.apply(this);
      //do inital update
      this.update();
    };

    Component.prototype._attachBindings = function() {

      function applyStringBinding(obj, key, prop) {

        obj._propHasChanged[key] = false;

        //now set the biders on the object
        Object.defineProperty(obj, key, {
          get: function() {
            return prop;
          },
          set: function(val) {
            if(val !== prop) {
              prop = val;
              obj._propHasChanged[key] = true;
              obj._checkDeps = true;
            }
          }
        })
      };

      for(var key in this) {
        if(key[0] !== "_") {
          var obj = this[key];
          if(!isFunction(obj)) {
            if(typeof obj === "string") {
              applyStringBinding(this, key, obj);
            }
          }
        }
      }
    };

    Component.prototype.update = function() {
      if(this._checkDeps === true) {
        this._render();
        this._checkDeps = false;
      }
      requestAnimationFrame(this.update.bind(this));
    };

    Component.prototype._renderNode = function(root, rootChanges, parentHasChanges, path) {
      var val = null;
      var hasChanged = false;

      if(Array.isArray(root)) {
        for(var i = 0; i < root.length; i++) {
          path += "[" + i + "]";
          this._renderNode(root[i], rootChanges, hasChanged, path);
        }
      } else {
        //check if this node has any dependencies
        if(root.deps != null) {
          //if so we run them and check vs our old deps
          for(var s = 0; s < root.deps.length; s++) {
            if(this._propHasChanged[root.deps[s]] === true) {
              this._propHasChanged[root.deps[s]] = false;
              //changed
              hasChanged = true;
              //if there are no
              if(parentHasChanges === false) {
                rootChanges.push({
                  path: path,
                  vnode: root
                });
              }
            }
          }
        }
        if(root.render != null && hasChanged === true) {
          root.children = root.render.apply(this);
        }
        if(root.children != null && typeof root.children !== "string") {
          path += ".children"
          this._renderNode(root.children, rootChanges, hasChanged, path);
        }
      }

    };

    Component.prototype._render = function() {
      var rootChanges = [];
      var level = 0;

      this._vDom = this._template;
      this._renderNode(this._vDom, rootChanges, false, "root");

      if(rootChanges.length > 0) {
        console.log("Detected changes to vdom, changes are:");
        console.log(rootChanges);
      }
    }

    return {
      String: String,
      Component: Component
    }

  })();


  function template() {

    return {
      tag: "div",
      children: [
        {
          deps: [
            //automatically remove "this" from this.name
            "name"
          ],
          tag: "div",
          render: function() { return "Hello my name is " + this.name }
        }
      ]
    };


  }

  var tpl = template();

  var widget = new Inferno.Component({
    constructor: function() {
      this.name = "Dominic";
    },
    template: template
  })



</script>
</html>
