<html>
<script>

  var Inferno = (function() {

    function isFunction(functionToCheck) {
      var getType = {};
      return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
    }

    function Component( data ) {
      this._lastChecks = [];
      this._vDom = {};
      //apply the constructor to this component
      data.constructor.apply(this);
      //go through the new properties and bind them to this component
      this._attachBindings();
      //handle the template
      this._template = data.template.apply(this);
      //do inital update
      this.update();
    };

    Component.prototype._attachBindings = function() {

      function applyStringBinding(obj, key, prop) {
        //now set the biders on the object
        Object.defineProperty(obj, key, {
          get: function() {
            return prop;
          },
          set: function(val) {
            prop = val;
            obj.update();
          }
        })
      };

      for(var key in this) {
        if(key[0] !== "_") {
          var obj = this[key];
          if(!isFunction(obj)) {
            if(typeof obj === "string") {
              applyStringBinding(this, key, obj);
            }
          }
        }
      }
    };

    Component.prototype.update = function() {
      var newChecks = this._template.checks.apply(this);
      var i = 0;
      var s = 0;
      var hasChange = false;
      var changeList = [];

      if(this._oldChecks != null) {
        for(i = 0; i < newChecks.length; i++) {
          for(s = 0; s < newChecks[i].deps.length; s++) {
            if(newChecks[i].deps[s] !== this._oldChecks[i].deps[s]) {
              hasChange = true;
              changeList.push(newChecks[i].ref);
            }
          }
        }
      } else {
        this._oldChecks = newChecks;
        hasChange = true;
      }

      if(hasChange === true) {
        console.log(changeList);
        this._oldChecks = newChecks;
        this._render();
      }
    };

    Component.prototype._renderNode = function(root) {
      if(Array.isArray(root)) {
        for(var i = 0; i < root.length; i++) {
          this._renderNode(root[i]);
        }
      } else {
        if(root.render != null) {
          root.children = root.render.apply(this);
        }
        if(root.children != null && typeof root.children !== "string") {
          this._renderNode(root.children);
        }
      }

    };

    Component.prototype._render = function() {
      this._vDom = this._template.vdom;
      this._renderNode(this._vDom);
      console.log(this._vDom);
    }

    return {
      String: String,
      Component: Component
    }

  })();


  function template() {

    var vdom = {
      tag: "div",
      children: [
        {
          tag: "div",
          render: function() { return "Hello my name is " + this.name }
        }
      ]
    };

    var checks = function() {
      return [
        {
          deps: [
            this.name
          ],
          ref: vdom.children[0]
        }
      ];
    }

    return {
      checks: checks,
      vdom: vdom
    }

  }

  var tpl = template();

  var widget = new Inferno.Component({
    constructor: function() {
      this.name = "Dominic";
    },
    template: template
  })



</script>
</html>
