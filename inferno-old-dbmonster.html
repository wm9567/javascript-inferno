<html>
<head>
  <title>Inferno example</title>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <dbmonster-app></dbmonster-app>

  <script src="inferno2.js"></script>
  <script src="data.js"></script>
  <script src="lib/memory-stats.js"></script>
  <script src="lib/monitor.js"></script>
  <script src="t7.js"></script>
  <script>

    var data = {Database: Database};
    var I = 0;
    var N = 100;

    function getCountClassName(db) {
      var count = db.queries.length;
      var className = 'label';
      if (count >= 20) {
          className += ' label-important';
      }
      else if (count >= 10) {
          className += ' label-warning';
      }
      else {
          className += ' label-success';
      }
      return className;
    }

    function elapsedClassName(elapsed) {
      var className = 'Query elapsed';
      if (elapsed >= 10.0) {
          className += ' warn_long';
      }
      else if (elapsed >= 1.0) {
          className += ' warn';
      }
      else {
          className += ' short';
      }
      return className;
    }

    function formatElapsed(value) {
      if (!value) return '';
      var str = parseFloat(value).toFixed(2);
      if (value > 60) {
          var minutes = Math.floor(value / 60);
          var comps = (value % 60).toFixed(2).split('.');
          var seconds = comps[0].lpad('0', 2);
          var ms = comps[1];
          str = minutes + ":" + seconds + "." + ms;
      }
      return str;
    }

    var cachedRender = function() {
      return {tag: "table", attrs: [{name: "class", value: "table table-striped latest-data"}], children: [{tag: "tbody", children: [Inferno.createValueNode(this.state.dbs.map(this._renderDatabase), 0)]}]}
    }

    var cachedRenderDatabase = function(db) {
      return {tag: "tr", children: [{tag: "td", attrs: [{name: "class", value: "dbanme"}], children: Inferno.createValueNode(db.name, 0)}, {tag: "td", attrs: [{name: "class", value: "query-count"}], children: [{tag: "span", attrs: [{name: "class", value: Inferno.createValueNode(getCountClassName(db), 1)}], children: Inferno.createValueNode(db.queries.length, 2)}]}, Inferno.createValueNode(db.getTopFiveQueries().map(this._renderQuery), 3)]}
    }

    var cachedRenderQuery = function(query) {
      return {tag: "td", atts: [{name: "class", value: Inferno.createValueNode('Query ' + elapsedClassName(query.elapsed), 0)}],children: [{tag: "span",attrs: [{name: "class", value: "foo"}],children: Inferno.createValueNode(formatElapsed(query.elapsed), 1)},{tag: "div",attrs: [{name: "class", value: "popover left"}],children: [{tag: "div",attrs: [{name: "class", value: "popover-content"}],children: Inferno.createValueNode(query.query, 2)},{tag: "div",attrs: [{name: "class", value: "arrow"}]}]}]}
    }

    var DbmonsterApp = Inferno.createComponent({
      constructor: function(props) {
        this.state.dbs = [];
        this._initDbs();
        this._updateDbs();
      },
      _initDbs: function() {
        for (var i = 0; i < N; i++) {
          this.state.dbs.push(new data.Database('cluster' + i));
          this.state.dbs.push(new data.Database('cluster' + i + 'slave'));
        }
      },
      _updateDbs: function() {
        for (var i = 0; i < this.state.dbs.length; i++) {
          this.state.dbs[i].update();
        };
        this.render();
        Monitoring.renderRate.ping();
        setTimeout(this._updateDbs, 0);
      },
      render: function() {
        // return t7`
        //   <table class="table table-striped latest-data">
        //     <tbody>
        //       ${ this.state.dbs.map(this._renderDatabase) }
        //     </tbody>
        //   </table>
        // `;
        return t7.precompile(
          cachedRender.bind(this),
          [this.state.dbs.map(this._renderDatabase)]
        );
      },
      _renderDatabase: function(db) {
        // return t7`
        //   <tr>
        //     <td class="dbname">${ db.name }</td>
        //     <td class="query-count"><span class=${ getCountClassName(db) }>${ db.queries.length }</span></td>
        //     ${ db.getTopFiveQueries().map(this._renderQuery) }
        //   </tr>
        // `;
        return t7.precompile(
          cachedRenderDatabase.bind(this, db),
          [db.name, getCountClassName(db), db.queries.length, db.getTopFiveQueries().map(this._renderQuery)]
        );
      },
      _renderQuery: function(query) {
        // return t7`
        //   <td class=${ 'Query ' + elapsedClassName(query.elapsed) }>
        //     <span class="foo">${ formatElapsed(query.elapsed) }</span>
        //     <div class="popover left">
        //       <div class="popover-content">${ query.query }</div>
        //       <div class="arrow"></div>
        //     </div>
        //   </td>
        // `;
        return t7.precompile(
          cachedRenderQuery.bind(this, query),
          ['Query ' + elapsedClassName(query.elapsed), formatElapsed(query.elapsed), query.query]
        );
      }
    });

    Inferno.registerComponent("dbmonster-app", DbmonsterApp);

  </script>
</body>
</html>
