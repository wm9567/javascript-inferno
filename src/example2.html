<html>
<body>
</body>
<script>
  "use strict";

  var Inferno = {};

  function Node(dom, render) {
    this._attached = false;
    this.dom = dom;
    this._className = "";
    this._text = null;
    this.key = null;
    this._children = [];
    this._childrenRender = {};
    this._childrenMap = {};
    this.render = render || null;
    if(render) {
      render(this);
    }
  }

  Node.prototype.setClass = function(className) {
    if(this._className !== className) {
      this.dom.className = className;
      this._className = className;
    }
  };

  Node.prototype.createElement = function(tag, render) {
    if(this._attached === false) {
      var childDom = document.createElement(tag);
      var childNode = new Node(childDom, render);
      this._children.push(childNode);
      this._childrenRender[render] = childNode;
      childNode.attach();
    } else {
      render(this._childrenRender[render]);
    }
  };

  Node.prototype.createElementWithMap = function(tag, array, keyName, render) {
    if(this._attached === false) {
      var childDom = null;
      var childNode = null;
      if(!this._childrenMap[render]) {
        this._childrenMap[render] = [];
      }
      for(var i = 0; i < array.length; i++) {
        childDom = document.createElement(tag);
        childNode = new Node(childDom, null);
        if(keyName !== null) {
          if(array[i][keyName] === undefined) {
            throw Error("Key property is invalid '" + keyName + "'");
          } else {
            childNode.key = array[i][keyName];
          }
        }
        render(childNode, array[i], i);
        this._children.push(childNode);
        this._childrenMap[render].push(childNode);
      }
    } else {
      var map = this._childrenMap[render];
      var key = null;
      var parentNode = null;
      var swapNode = null;
      var currentChild = null;
      //really basic, poor implemtation of keyed nodes to show this working
      if(map[0]) {
        parentNode = map[0].dom.parentNode;
      }
      for(var i = array.length - 1, s = 0; i > -1; i--) {
        key = array[i][keyName];
        currentChild = map[i];
        for(s = map.length - 1; s > -1; s--) {
          if(key === map[s].key) {
            parentNode.appendChild(map[s].dom);
            swapNode = map[s];
            map[s] = map[i];
            map[i] = swapNode;
            break;
          }
        }
        render(map[i], array[i], i);
      }
    }
  };

  Node.prototype.attach = function() {
    for(var i = 0; i < this._children.length; i++) {
      this.dom.appendChild(this._children[i].dom);
    }
    this._attached = true;
  };

  Inferno.render = function(render, dom) {
    if(dom.rootNode === undefined) {
      var rootNode = new Node(dom);
      render(rootNode);
      rootNode.attach();
      dom.rootNode = rootNode;
    } else {
      render(dom.rootNode);
    }
  };

  Node.prototype.setText = function(text) {
    if(this._text !== text) {
      if(this._attached === false) {
        this.dom.textContent = text;
      } else {
        this.dom.firstChild.nodeValue = text;
      }
      this._text = text;
    }
  };

  var render = (function() {
    function _createNode1(node) {
      node.createElement("ul", _createNode2);
    }
    function _createNode2(node) {
      node.createElementWithMap("li", listToUse, "key", _createNode3);
    }
    function _createNode3(node, item, index) {
      node.setText(item.key.toString());
    }
    function render(rootNode) {
      rootNode.createElement("div", _createNode1)
    }

    return render;
  })();

  var newVal = "";
  var list1 = [];
  var list2 = [];
  var listToUse = list1;
  //prepopulate with 500 notes
  for(var i = 0; i < 500; i++) {
    list1.push({key: i})
  }

  for(var i = 0; i < 500; i++) {
    list2.push({key: 499 - i})
  }

  var flag = 0;

  function update() {
    console.time("render");
    if(listToUse === list1) {
      listToUse = list2;
    } else {
      listToUse = list1;
    }
    Inferno.render(render, document.body);
    console.timeEnd("render");

    setTimeout(update, 1000);
  }

  update();

</script>
</html>
