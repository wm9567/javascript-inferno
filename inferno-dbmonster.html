<html>
<head>
  <title>Inferno DBMonster</title>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="app"></div>
  <script src="inferno.js"></script>
  <script src="t7.js"></script>
  <script src="data.js"></script>
  <script src="lib/memory-stats.js"></script>
  <script src="lib/monitor.js"></script>
  <script>

    var data = {Database: Database};
    var I = 0;
    var N = 100;

    var state = {
      dbs: []
    };

    for (var i = 0; i < N; i++) {
      state.dbs.push(new data.Database('cluster' + i));
      state.dbs.push(new data.Database('cluster' + i + 'slave'));
    }

    var computed = {
      getCountClassName: function(db) {
        var count = db.queries.length;
        var className = 'label';
        if (count >= 20) {
            className += ' label-important';
        }
        else if (count >= 10) {
            className += ' label-warning';
        }
        else {
            className += ' label-success';
        }
        return className;
      },
      elapsedClassName: function(elapsed) {
        var className = 'Query elapsed';
        if (elapsed >= 10.0) {
            className += ' warn_long';
        }
        else if (elapsed >= 1.0) {
            className += ' warn';
        }
        else {
            className += ' short';
        }
        return className;
      },
      formatElapsed: function(value) {
        if (!value) return '';
        var str = parseFloat(value).toFixed(2);
        if (value > 60) {
            var minutes = Math.floor(value / 60);
            var comps = (value % 60).toFixed(2).split('.');
            var seconds = comps[0].lpad('0', 2);
            var ms = comps[1];
            str = minutes + ":" + seconds + "." + ms;
        }
        return str;
      }
    };

    function query(scope, computed) {
      return {
        tag: "td",
        attrs: [
          {
            name: "class",
            value: function(scope, computed) { return 'Query ' + computed.elapsedClassName(scope.elapsed); }
          }
        ],
        children: [
          {
            tag: "span",
            attrs: [
              {
                name: "class",
                value: "foo"
              }
            ],
            children: function(scope, computed) { return computed.formatElapsed(scope.elapsed); }
          },
          {
            tag: "div",
            attrs: [
              {
                name: "class",
                value: "popover left"
              }
            ],
            children: [
              {
                tag: "div",
                attrs: [
                  {
                    name: "class",
                    value: "popover-content"
                  }
                ],
                children: function(scope, computed) { return scope.query; }
              },
              {
                tag: "div",
                attrs: [
                  {
                    name: "class",
                    value: "arrow"
                  }
                ]
              }
            ]
          }
        ]
      }
    }

    function database(scope, computed) {
      var map = Inferno.TemplateHelpers.map;
      var ClipBox = Inferno.TemplateHelpers.ClipBox;

      return {
        tag: "tr",
        clipBox: ClipBox.FixedHeight,
        children: [
          {
            tag: "td",
            attrs: [
              {
                name: "class",
                value: "dbname"
              }
            ],
            children: function(scope, computed) { return scope.name; }
          },
          {
            tag: "td",
            attrs: {
              "class": "query-count"
            },
            children: {
              tag: "span",
              attrs: [
                {
                  name: "class",
                  value: function(scope, computed) { return computed.getCountClassName(scope); }
                }
              ],
              children: function(scope, computed) { return scope.queries.length; }
            }
          },
          function(scope, model) { return map(scope.getTopFiveQueries, query) }
        ]
      }
    }

    function template(scope, computed) {
      var map = Inferno.TemplateHelpers.map;
      var ClipBox = Inferno.TemplateHelpers.ClipBox;

      return {
        tag: "table",
        attrs: [
          {
            name: "class",
            value: "table table-striped latest-data"
          }
        ],
        children: {
          tag: "tbody",
          children: function(scope, model) { return map(scope.dbs, database) }
        }
      }
    };

    var app = document.getElementById("app");
    var root = Inferno.append(template, state, computed, app);

    //shortcut for dev purposes
    function u() {
      for (var i = 0; i < state.dbs.length; i++) {
        state.dbs[i].update();
      };
      Inferno.update(root, app, state, computed)
      Monitoring.renderRate.ping();
      setTimeout(u, 0);
    };

    u();

  </script>
</body>
</html>
