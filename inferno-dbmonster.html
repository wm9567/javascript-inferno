<html>
<head>
  <link rel="stylesheet" href="bootstrap.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="link">
  You're looking at a Inferno<br>
  version of <a href="https://dbmonster.firebaseapp.com/">DBMonster</a>.<br>
  <a class="center" href="https://github.com/trueadm/dbmonster">See it on GitHub</a>
</div>

<div id="body">
</div>

<script src="inferno.js"></script>
<script src="data.js"></script>
<script src="lib/memory-stats.js"></script>
<script src="lib/monitor.js"></script>
<script src="t7.js"></script>

<script type="text/javascript">

  var rootNode = null;
  var once = false;
  var dbs = [];
  var body = document.getElementById('body');
  var map = Inferno.TemplateHelpers.map;

  function getTime(dbIndex, queryIndex) {
    var value = dbs[dbIndex].topFiveQueries[queryIndex].elapsed;

    if (!value) return '';
    var str = parseFloat(value).toFixed(2);
    if (value > 60) {
      var minutes = Math.floor(value / 60);
      var comps = (value % 60).toFixed(2).split('.');
      var seconds = comps[0].lpad('0', 2);
      var ms = comps[1];
      str = minutes + ":" + seconds + "." + ms;
    }
    return str;
  }

  function getQueryText(dbIndex, queryIndex) {
    return dbs[dbIndex].topFiveQueries[queryIndex].query;
  }

  function getElapsedClass(dbIndex, queryIndex) {
    var elapsed = dbs[dbIndex].topFiveQueries[queryIndex].elapsed;

    var className = 'Query elapsed';
    if (elapsed >= 10.0) {
      className += ' warn_long';
    }
    else if (elapsed >= 1.0) {
      className += ' warn';
    }
    else {
      className += ' short';
    }

    return 'Query ' + className;
  }

  function queries(dbIndex, query, queryIndex) {
    return Inferno.createElement("td", {class: getElapsedClass.bind(null, dbIndex, queryIndex) },
      Inferno.createElement("span", {class: "foo"},getTime.bind(null, dbIndex, queryIndex)),
      Inferno.createElement("div", {class: "popover left"},
        Inferno.createElement("div", {class: "popover-content"}, getQueryText.bind(null, dbIndex, queryIndex)),
        Inferno.createElement("div", {class: "arrow"}, null)
      )
    )
    //t7 version
    // function queries(dbIndex, query, queryIndex) {
    //   return t7`
    //     <td class="${ getElapsedClass.bind(null, dbIndex, queryIndex) }">
    //       <span class="foo">${ getTime.bind(null, dbIndex, queryIndex) }</span>
    //       <div class="popover left">
    //         <div class="popover-content">${ getQueryText.bind(null, dbIndex, queryIndex) }</div>
    //         <div class="arrow"></div>
    //       </div>
    //     </td>`
    // }
  }



  function getTop5Queries(index) {
    var db = dbs[index];
    return db.topFiveQueries;
  }

  function getQueriesLength(index) {
    var db = dbs[index];
    return db.queries.length;
  }

  function getCountClass(index) {
    var count = getLastSample(dbs[index]).queries.length;
    var className = 'label';
    if (count >= 20) {
      className += ' label-important';
    }
    else if (count >= 10) {
      className += ' label-warning';
    }
    else {
      className += ' label-success';
    }
    return className;
  }

  function database(db, index) {
    return Inferno.createElement("tr", {key: db.name},
      Inferno.createElement("td", {class: "dbname"}, db.name),
      Inferno.createElement("td", {class: "query-count"},
        Inferno.createElement("span", {class: getCountClass.bind(null, index) }, getQueriesLength.bind(null, index))
      ),
      map(getTop5Queries.bind(null, index), queries.bind(null, index))
    )
    //t7 version
    // return t7`
    //   <tr key="${ db.name }">
    //
    //     <td class="dbname">
    //       ${ db.name }
    //     </td>
    //
    //     <td class="query-count">
    //       <span class="${ getCountClass.bind(null, index) }">
    //         ${ getQueriesLength.bind(null, index) }
    //       </span>
    //     </td>
    //
    //     ${ map(getTop5Queries.bind(null, index), queries.bind(null, index)) }
    //
    //   </tr>
    // `
  }

  function getDbs() {
    return dbs;
  }

  function table() {
    return Inferno.createElement("table", {class: "table table-striped latest-data"},
      Inferno.createElement("tbody", null,
        map(getDbs, database )
      )
    )
    //t7 version
    // return t7`
    //   <table class="table table-striped latest-data">
    //     <tbody>
    //       ${ map(getDbs, database )}
    //     </tbody>
    //   </table>
    // `;
  }

  function update() {
    dbs = getData();

    if(rootNode === null) {
      rootNode = Inferno.append(table, null, body);
    } else {
      //cito.vdom.update(rootNode, table);
      Inferno.update(rootNode, null, body);
    }

    Monitoring.renderRate.ping();

    if(once === false) {
      requestAnimationFrame(update);
    }
  }

  requestAnimationFrame(update);

</script>
</body>
</html>
